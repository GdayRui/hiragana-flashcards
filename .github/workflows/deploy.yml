name: Deploy to AWS Amplify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: '18'
  AWS_REGION: 'ap-southeast-2' # Change to your preferred region

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Debug deployment parameters
      run: |
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "GitHub Token length: ${#GITHUB_TOKEN}"
        echo "GH_PAT available: $([[ -n "$GH_PAT" ]] && echo "YES" || echo "NO")"
        echo "GH_PAT length: ${#GH_PAT}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_PAT: ${{ secrets.GH_PAT }}
    
    - name: Check and handle existing stack
      run: |
        STACK_STATUS=$(aws cloudformation describe-stacks \
          --stack-name hiragana-flash-cards-stack \
          --query 'Stacks[0].StackStatus' \
          --output text 2>/dev/null || echo "STACK_NOT_EXISTS")
        
        echo "Current stack status: $STACK_STATUS"
        
        if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "CREATE_FAILED" ] || [ "$STACK_STATUS" = "DELETE_FAILED" ]; then
          echo "Deleting failed stack..."
          aws cloudformation delete-stack --stack-name hiragana-flash-cards-stack
          
          echo "Waiting for stack deletion to complete..."
          aws cloudformation wait stack-delete-complete --stack-name hiragana-flash-cards-stack
          
          echo "Stack deleted successfully"
        elif [ "$STACK_STATUS" != "STACK_NOT_EXISTS" ]; then
          echo "Stack exists with status: $STACK_STATUS"
        fi
        
    - name: Deploy CloudFormation stack
      uses: aws-actions/aws-cloudformation-github-deploy@v1
      with:
        name: hiragana-flash-cards-stack
        template: .aws/amplify-stack.yml
        parameter-overrides: |
          AppName=hiragana-flash-cards,
          Repository=${{ github.repository }},
          Branch=${{ github.ref_name }},
          GitHubToken=${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        capabilities: CAPABILITY_NAMED_IAM
        no-fail-on-empty-changeset: "1"
        
    - name: Get Amplify App Info
      run: |
        APP_ID=$(aws cloudformation describe-stacks \
          --stack-name hiragana-flash-cards-stack \
          --query 'Stacks[0].Outputs[?OutputKey==`AmplifyAppId`].OutputValue' \
          --output text)
        CONSOLE_URL="https://console.aws.amazon.com/amplify/home#/${APP_ID}"
        echo "ğŸš€ Amplify app created successfully!"
        echo "ğŸ“± App ID: $APP_ID"
        echo "ğŸ”§ Next step: Connect your repository manually in AWS Console"
        echo "ğŸŒ AWS Console: $CONSOLE_URL"
        echo "APP_ID=$APP_ID" >> $GITHUB_ENV
        echo "CONSOLE_URL=$CONSOLE_URL" >> $GITHUB_ENV
        
    - name: Comment PR with deployment info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ **Amplify App Created!**\n\nğŸ“± **App ID:** ${{ env.APP_ID }}\nğŸ”§ **Next:** Connect repository in AWS Console\nğŸŒ **Console:** ${{ env.CONSOLE_URL }}`
          })