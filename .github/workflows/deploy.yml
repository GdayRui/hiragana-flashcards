name: Deploy to AWS Amplify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: '18'
  AWS_REGION: 'ap-southeast-2' # Change to your preferred region

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Debug deployment parameters
      run: |
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "GitHub Token length: ${#GITHUB_TOKEN}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Deploy CloudFormation stack
      uses: aws-actions/aws-cloudformation-github-deploy@v1
      with:
        name: hiragana-flash-cards-stack
        template: .aws/amplify-stack.yml
        parameter-overrides: |
          AppName=hiragana-flash-cards,
          Repository=${{ github.repository }},
          Branch=${{ github.ref_name }},
          GitHubToken=${{ secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
        capabilities: CAPABILITY_NAMED_IAM
        no-fail-on-empty-changeset: "1"
        
    - name: Get Amplify App URL
      run: |
        APP_ID=$(aws cloudformation describe-stacks \
          --stack-name hiragana-flash-cards-stack \
          --query 'Stacks[0].Outputs[?OutputKey==`AmplifyAppId`].OutputValue' \
          --output text)
        APP_URL="https://${{ github.ref_name }}.${APP_ID}.amplifyapp.com"
        echo "ðŸš€ App deployed successfully!"
        echo "ðŸ“± App URL: $APP_URL"
        echo "APP_URL=$APP_URL" >> $GITHUB_ENV
        
    - name: Comment PR with deployment info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš€ **Deployment Preview Ready!**\n\nðŸ“± **Preview URL:** ${{ env.APP_URL }}\n\nâœ… Your Hiragana Flash Cards app has been deployed successfully.`
          })